--[[
ESP Module v2
Adds health bars, name tags, team tags, and distance readâ€‘outs with individual toggles.
Author: ChatGPT & mrwompington ðŸ˜Ž
--]]

local Players     = game:GetService("Players")
local RunService  = game:GetService("RunService")
local Teams       = game:GetService("Teams")
local Camera      = workspace.CurrentCamera

--// CONFIG
local BOX_COLOR       = Color3.fromRGB(255, 0, 0)
local BOX_THICKNESS   = 2
local SCALE_CONST     = 2000

local settings = {
    ShowBoxes    = true,
    ShowHealth   = true,
    ShowNames    = true,
    ShowTeam     = true,
    ShowDistance = true,
}

-- internal containers
local espObjects = {}
local connection

---------------------------------------------------------------------
--\ Drawing object factories //
---------------------------------------------------------------------
local function newSquare()
    local sq = Drawing.new("Square")
    sq.Visible  = false
    sq.Color    = BOX_COLOR
    sq.Thickness= BOX_THICKNESS
    sq.Filled   = false
    return sq
end

local function newText()
    local t   = Drawing.new("Text")
    t.Visible = false
    t.Center  = true
    t.Outline = true
    t.Size    = 14
    t.Color   = Color3.fromRGB(255,255,255)
    return t
end

local function newLine()
    local l   = Drawing.new("Line")
    l.Visible = false
    l.Thickness = 2
    return l
end

local function createESPEntry()
    return {
        Box          = newSquare(),
        HealthFill   = newSquare(),
        HealthOutline= newSquare(),
        Name         = newText(),
        Info         = newText(), -- distance & team
    }
end

---------------------------------------------------------------------
--\ Helpers //
---------------------------------------------------------------------
local function clamp(v, mi, ma)
    return v < mi and mi or (v > ma and ma or v)
end

local function getEntry(plr)
    if not espObjects[plr] then
        espObjects[plr] = createESPEntry()
    end
    return espObjects[plr]
end

local function removeEntry(plr)
    local entry = espObjects[plr]
    if not entry then return end
    for _,obj in pairs(entry) do
        if obj.Remove then obj:Remove() end
    end
    espObjects[plr] = nil
end

---------------------------------------------------------------------
--\ Core render loop //
---------------------------------------------------------------------
local function renderESP()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= Players.LocalPlayer then
            local char = plr.Character
            local hrp  = char and char:FindFirstChild("HumanoidRootPart")
            local hum  = char and char:FindFirstChildOfClass("Humanoid")
            local entry = getEntry(plr)

            if hrp and Camera then
                local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local distance = (Camera.CFrame.Position - hrp.Position).Magnitude
                    local width  = clamp(SCALE_CONST / distance, 50, 500)
                    local height = clamp(width * 2, 100, 1000)

                    -----------------------------------------------------------------
                    -- Box
                    -----------------------------------------------------------------
                    if settings.ShowBoxes then
                        entry.Box.Size     = Vector2.new(width, height)
                        entry.Box.Position = Vector2.new(pos.X - width/2, pos.Y - height/2)
                        entry.Box.Color    = BOX_COLOR
                        entry.Box.Visible  = true
                    else
                        entry.Box.Visible = false
                    end

                    -----------------------------------------------------------------
                    -- Health bar (left side of box)
                    -----------------------------------------------------------------
                    if settings.ShowHealth and hum then
                        local hpRatio = clamp(hum.Health / hum.MaxHealth, 0, 1)

                        -- Outline
                        entry.HealthOutline.Size     = Vector2.new(4, height)
                        entry.HealthOutline.Position = Vector2.new(pos.X - width/2 - 6, pos.Y - height/2)
                        entry.HealthOutline.Filled   = false
                        entry.HealthOutline.Color    = Color3.new(0,0,0)
                        entry.HealthOutline.Visible  = true

                        -- Fill
                        entry.HealthFill.Size        = Vector2.new(4, height * hpRatio)
                        entry.HealthFill.Position    = Vector2.new(pos.X - width/2 - 6, pos.Y + height/2 - height * hpRatio)
                        entry.HealthFill.Filled      = true
                        entry.HealthFill.Color       = Color3.fromRGB(255*(1-hpRatio),255*hpRatio,0)
                        entry.HealthFill.Visible     = true
                    else
                        entry.HealthOutline.Visible = false
                        entry.HealthFill.Visible    = false
                    end

                    -----------------------------------------------------------------
                    -- Name & tags
                    -----------------------------------------------------------------
                    if settings.ShowNames or settings.ShowTeam or settings.ShowDistance then
                        local nameStr = ""
                        if settings.ShowNames then nameStr = plr.Name end
                        if settings.ShowTeam and plr.Team then
                            nameStr = nameStr .. (nameStr ~= "" and " | " or "") .. plr.Team.Name
                        end
                        if settings.ShowDistance then
                            nameStr = nameStr .. (nameStr ~= "" and " | " or "") .. string.format("%dm", distance//1)
                        end
                        entry.Name.Text     = nameStr
                        entry.Name.Position = Vector2.new(pos.X, pos.Y - height/2 - 16)
                        entry.Name.Visible  = nameStr ~= ""
                    else
                        entry.Name.Visible = false
                    end

                else -- not on screen
                    for _,obj in pairs(entry) do obj.Visible = false end
                end
            else -- no hrp
                for _,obj in pairs(entry) do obj.Visible = false end
            end
        end
    end
end

---------------------------------------------------------------------
--\ Public API //
---------------------------------------------------------------------
local function Enable()
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= Players.LocalPlayer then getEntry(plr) end
    end
    Players.PlayerRemoving:Connect(removeEntry)
    Players.PlayerAdded:Connect(function(plr)
        if plr ~= Players.LocalPlayer then getEntry(plr) end
    end)
    connection = RunService.RenderStepped:Connect(renderESP)
end

local function Disable()
    if connection then connection:Disconnect(); connection = nil end
    for plr,_ in pairs(espObjects) do removeEntry(plr) end
end

local function SetColor(color)
    BOX_COLOR = color
end

-- toggle helpers
local function ToggleHealthBars(state) settings.ShowHealth   = state end
local function ToggleNameTags(state)  settings.ShowNames    = state end
local function ToggleTeamTags(state)  settings.ShowTeam     = state end
local function ToggleDistance(state)  settings.ShowDistance = state end
local function ToggleBoxes(state)     settings.ShowBoxes    = state end

return {
    Enable            = Enable,
    Disable           = Disable,
    SetColor          = SetColor,
    ToggleHealthBars  = ToggleHealthBars,
    ToggleNameTags    = ToggleNameTags,
    ToggleTeamTags    = ToggleTeamTags,
    ToggleDistance    = ToggleDistance,
    ToggleBoxes       = ToggleBoxes,
}
