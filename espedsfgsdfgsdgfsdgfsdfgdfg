--[[
ESP Module v2
Adds health bars, name tags, team tags, and distance readâ€‘outs with individual toggles.
Author: ChatGPT & mrwompington ðŸ˜Ž
--]]

local Players     = game:GetService("Players")
local RunService  = game:GetService("RunService")
local Teams       = game:GetService("Teams")
local Camera      = workspace.CurrentCamera

--// CONFIG
local BOX_COLOR       = Color3.fromRGB(255, 0, 0)
local BOX_THICKNESS   = 2
local SCALE_CONST     = 2000

local settings = {
    ShowBoxes    = true,
    ShowHealth   = true,
    ShowNames    = true,
    ShowTeam     = true,
    ShowDistance = true,
}

-- internal containers
local espObjects = {}
local connection

---------------------------------------------------------------------
--\ Drawing object factories //
---------------------------------------------------------------------
local function newSquare()
    local sq = Drawing.new("Square")
    sq.Visible  = false
    sq.Color    = BOX_COLOR
    sq.Thickness= BOX_THICKNESS
    sq.Filled   = false
    return sq
end

local function newText()
    local t   = Drawing.new("Text")
    t.Visible = false
    t.Center  = true
    t.Outline = true
    t.Size    = 14
    t.Color   = Color3.fromRGB(255,255,255)
    return t
end

local function newLine()
    local l   = Drawing.new("Line")
    l.Visible = false
    l.Thickness = 2
    return l
end

local function createESPEntry()
    return {
        Box          = newSquare(),
        HealthFill   = newSquare(),
        HealthOutline= newSquare(),
        Name         = newText(),
        Info         = newText(), -- distance & team
    }
end

---------------------------------------------------------------------
--\ Helpers //
---------------------------------------------------------------------
local function clamp(v, mi, ma)
    return v < mi and mi or (v > ma and ma or v)
end

local function getEntry(plr)
    if not espObjects[plr] then
        espObjects[plr] = createESPEntry()
    end
    return espObjects[plr]
end

local function removeEntry(plr)
    local entry = espObjects[plr]
    if not entry then return end
    for _,obj in pairs(entry) do
        if obj.Remove then obj:Remove() end
    end
    espObjects[plr] = nil
end

---------------------------------------------------------------------
--\ Core render loop //
---------------------------------------------------------------------
local function renderESP()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= Players.LocalPlayer then
            local char = plr.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            local humanoid = char and char:FindFirstChildOfClass("Humanoid")
            local box = getBox(plr)
            local data = playerData[plr] or {}

            if hrp and Camera then
                local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local dist = (Camera.CFrame.Position - hrp.Position).Magnitude
                    local width = clamp(SCALE_CONST / dist, 50, 500)
                    local height = clamp(width * 2, 100, 1000)
                    box.Size = Vector2.new(width, height)
                    box.Position = Vector2.new(screenPos.X - width / 2, screenPos.Y - height / 2)
                    box.Visible = true

                    if showHealthbar and humanoid then
                        data.healthbar.Size = Vector2.new(4, height * (humanoid.Health / humanoid.MaxHealth))
                        data.healthbar.Position = Vector2.new(box.Position.X - 6, box.Position.Y + (height - data.healthbar.Size.Y))
                        data.healthbar.Visible = true
                    end

                    if showNameTag then
                        data.name.Text = plr.Name
                        data.name.Position = Vector2.new(screenPos.X, screenPos.Y - height / 2 - 16)
                        data.name.Visible = true
                    end

                    if showTeamTag then
                        data.team.Text = tostring(plr.Team)
                        data.team.Position = Vector2.new(screenPos.X, screenPos.Y + height / 2)
                        data.team.Visible = true
                    end

                    if showDistance then
                        data.distance.Text = tostring(math.floor(dist)) .. "m"
                        data.distance.Position = Vector2.new(screenPos.X, screenPos.Y + height / 2 + 12)
                        data.distance.Visible = true
                    end

                else
                    box.Visible = false
                    if data.healthbar then data.healthbar.Visible = false end
                    if data.name then data.name.Visible = false end
                    if data.team then data.team.Visible = false end
                    if data.distance then data.distance.Visible = false end
                end
            else
                box.Visible = false
            end
        end
    end
end


---------------------------------------------------------------------
--\ Public API //
---------------------------------------------------------------------
local function Enable()
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= Players.LocalPlayer then getEntry(plr) end
    end
    Players.PlayerRemoving:Connect(removeEntry)
    Players.PlayerAdded:Connect(function(plr)
        if plr ~= Players.LocalPlayer then getEntry(plr) end
    end)
    connection = RunService.RenderStepped:Connect(renderESP)
end

local function Disable()
    if connection then connection:Disconnect(); connection = nil end
    for plr,_ in pairs(espObjects) do removeEntry(plr) end
end

local function SetColor(color)
    BOX_COLOR = color
end

-- toggle helpers
local function ToggleHealthBars(state) settings.ShowHealth   = state end
local function ToggleNameTags(state)  settings.ShowNames    = state end
local function ToggleTeamTags(state)  settings.ShowTeam     = state end
local function ToggleDistance(state)  settings.ShowDistance = state end
local function ToggleBoxes(state)     settings.ShowBoxes    = state end

return {
    Enable            = Enable,
    Disable           = Disable,
    SetColor          = SetColor,
    ToggleHealthBars  = ToggleHealthBars,
    ToggleNameTags    = ToggleNameTags,
    ToggleTeamTags    = ToggleTeamTags,
    ToggleDistance    = ToggleDistance,
    ToggleBoxes       = ToggleBoxes,
}
